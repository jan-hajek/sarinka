<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Title</title>

	<style type="text/css">
		body {
			margin: 0;
			padding: 0;
			background-color: black;
		}

		#preview {
			position: fixed;
			top: 0;
			right: 0;
			width: 240px;
			height: 100%;
			background-color: #f5f5f5;
			border-left: 1px solid #353535;
			padding: 10px;
			text-align: right;
		}

		#preview .image {
		}

		#preview .image img{
			width: 200px;
		}
	</style>
</head>
<body>
<div id="main">

	<div id="player"></div>
	<div id="preview">
		<div id="previewInfo">
		</div>
		<div id="previewItems">
		</div>
	</div>

</div>

<script>
	var url = location.protocol + "//" + location.hostname

	var port = location.port;
	if (port != "80") {
		url += ":"+ port
	}

    // 2. This code loads the IFrame Player API code asynchronously.
    var tag = document.createElement('script');

    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    // 3. This function creates an <iframe> (and YouTube player)
    //    after the API code downloads.
    var player;

    function onYouTubeIframeAPIReady() {
        getJSON(url + "/current/", function (status, response) {
            player = new YT.Player('player', {
                width: '1000',
                height: '580',
                videoId: response.videoId,
                playerVars: {"start": 1},
                events: {
                    'onReady': onPlayerReady,
                    // 'onStateChange': onPlayerStateChange
                }
            });
        })
        loadPreview();
    }

    function nextVideo() {
        getJSON(url + "/next/", function (status, response) {
            player.loadVideoById(response.videoId, 1)

			loadPreview();
        })

    }

    // 4. The API will call this function when the video player is ready.
    function onPlayerReady(event) {
        event.target.playVideo();
    }

    document.onkeydown = function (event) {
        switch (event.keyCode) {
            case 39:
                nextVideo();
                break;
        }
    };

    function loadPreview() {
        getJSON(url + "/preview/", function (status, response) {
            let previewInfo = document.getElementById("previewInfo")
            let previewItems = document.getElementById("previewItems")
            previewItems.innerHTML = "";
            previewInfo.innerHTML = response.Current + "/" + response.TotalCount

            response.Items.map(function (value, index, array) {
                var div = document.createElement("div");
				div.classList.add("image");
				div.classList.add("position"+ index);

                var img = new Image(value.Width);
                img.src = value.Url;

                div.appendChild(img);
                previewItems.appendChild(div);
            })

        })
    }

    function getJSON(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.responseType = 'json';
        xhr.onload = function () {
            var status = xhr.status;
            if (status === 200) {
                callback(null, xhr.response);
            } else {
                callback(status, xhr.response);
            }
        };
        xhr.send();
    };

    // 5. The API calls this function when the player's state changes.
    //    The function indicates that when playing a video (state=1),
    //    the player should play for six seconds and then stop.
    // var done = false;
    // function onPlayerStateChange(event) {
    //   if (event.data == YT.PlayerState.PLAYING && !done) {
    //     setTimeout(stopVideo, 6000);
    //     done = true;
    //   }
    // }
    // function stopVideo() {
    //   player.stopVideo();
    // }
</script>
</body>